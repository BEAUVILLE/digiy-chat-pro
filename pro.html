<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>DIGIY PRO CHAT ‚Äî Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800;900&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --panel:#08101f;
      --line:#1e293b;
      --ink:#f9fafb;
      --muted:#9ca3af;
      --accent:#f97316;
      --gold:#facc15;
      --ok:#22c55e;
      --danger:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      background:
        radial-gradient(circle at 12% 10%, rgba(249,115,22,.14), transparent 55%),
        radial-gradient(circle at 88% 85%, rgba(250,204,21,.10), transparent 60%),
        var(--bg);
      color:var(--ink);
      font-family:'Manrope',sans-serif;
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:100%;
      max-width:1200px;
      background:rgba(8,16,31,.92);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 70px rgba(0,0,0,.55);
    }
    header{
      padding:18px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      background:linear-gradient(135deg, rgba(11,18,34,.92), rgba(8,16,31,.92));
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .brand-logo{
      width:42px;height:42px;border-radius:16px;
      font-size:1.4rem;font-weight:900;
      background:conic-gradient(var(--accent),var(--gold),var(--accent));
      display:flex;justify-content:center;align-items:center;
      color:#020617;font-family:'Outfit',sans-serif;
      box-shadow:0 14px 34px rgba(249,115,22,.35);
    }
    .brand-title{font-size:1.15rem;font-weight:950;font-family:'Outfit',sans-serif;letter-spacing:.08em;text-transform:uppercase;}
    .brand-sub{font-size:.78rem;color:var(--muted);margin-top:2px;letter-spacing:.08em;text-transform:uppercase;}

    .top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      padding:7px 12px;border:1px solid rgba(51,65,85,.95);
      border-radius:999px;background:rgba(2,6,23,.35);
      color:var(--muted);font-weight:800;font-size:.82rem;white-space:nowrap;
    }
    .pill b{color:var(--ink)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:99px;background:rgba(148,163,184,.55);margin-right:8px;vertical-align:middle;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--danger)}

    .btn{
      border:none;border-radius:999px;padding:10px 14px;cursor:pointer;
      font-weight:950;letter-spacing:.08em;text-transform:uppercase;
      font-family:'Outfit',sans-serif;font-size:.78rem;display:inline-flex;align-items:center;gap:8px;
    }
    .btn.primary{background:linear-gradient(135deg,var(--accent),#ea580c);color:#111827;box-shadow:0 14px 30px rgba(249,115,22,.25);}
    .btn.ghost{background:rgba(2,6,23,.35);color:var(--ink);border:1px solid rgba(148,163,184,.35);}

    .layout{display:grid;grid-template-columns:0.95fr 1.45fr;min-height:620px;}
    @media(max-width:900px){.layout{grid-template-columns:1fr;}.sidebar{border-right:none;border-bottom:1px solid var(--line);}}

    .sidebar{border-right:1px solid var(--line);padding:16px;background:rgba(2,6,23,.22);}
    .sidebar-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;}
    .room-input{
      width:100%;border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.35);color:var(--ink);
      border-radius:14px;padding:10px 12px;outline:none;font-weight:800;
    }
    .room-input:focus{border-color:rgba(249,115,22,.75);box-shadow:0 0 0 3px rgba(249,115,22,.14);}
    .hint{font-size:.82rem;color:rgba(203,213,225,.85);font-weight:700;margin-top:10px;}
    .hint code{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);padding:2px 6px;border-radius:10px;color:#fff;}

    .chat-item{
      padding:12px;background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.18);
      border-radius:14px;margin-top:10px;display:flex;align-items:center;gap:12px;cursor:pointer;
      transition:transform .14s ease,border-color .14s ease;
    }
    .chat-item:hover{transform:translateY(-1px);border-color:rgba(249,115,22,.55);}
    .chat-avatar{
      width:34px;height:34px;background:radial-gradient(var(--accent),var(--gold));
      border-radius:12px;color:#000;display:flex;justify-content:center;align-items:center;
      font-weight:950;font-family:'Outfit',sans-serif;
    }
    .chat-meta{display:flex;flex-direction:column;gap:2px}
    .chat-name{font-weight:900}
    .chat-sub{font-size:.78rem;color:var(--muted);font-weight:700}

    .main{padding:18px;display:flex;flex-direction:column;gap:10px;}
    .main-head{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;
      padding-bottom:10px;border-bottom:1px solid rgba(148,163,184,.18);
    }
    .h-title{font-size:1.08rem;font-weight:950;font-family:'Outfit',sans-serif;}
    .h-sub{font-size:.82rem;color:var(--muted);font-weight:700;margin-top:3px;}

    .who{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .tag{font-size:11px;color:rgba(203,213,225,.85);letter-spacing:.12em;text-transform:uppercase;font-weight:900;}
    .select,.input{
      border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.35);color:var(--ink);
      border-radius:14px;padding:10px 12px;outline:none;font-weight:800;
    }
    .select{padding:9px 10px}
    .input::placeholder{color:rgba(156,163,175,.85)}
    .select:focus,.input:focus{border-color:rgba(249,115,22,.75);box-shadow:0 0 0 3px rgba(249,115,22,.14);}

    .messages{flex:1;overflow:auto;padding:10px 4px 6px;scroll-behavior:smooth;}
    .msg-row{display:flex;flex-direction:column;gap:6px;margin:10px 0;max-width:78%;}
    .msg-row.pro{margin-left:auto;align-items:flex-end;}
    .msg-row.client{margin-right:auto;align-items:flex-start;}
    .msg{
      padding:12px 14px;border-radius:14px;background:rgba(15,23,42,.72);
      border:1px solid rgba(148,163,184,.18);line-height:1.55;font-weight:700;white-space:pre-wrap;word-break:break-word;
    }
    .msg.pro{background:linear-gradient(135deg, rgba(249,115,22,.85), rgba(250,204,21,.35));color:#111827;border-color:rgba(249,115,22,.55);}
    .msg-meta{font-size:11px;color:rgba(203,213,225,.75);font-weight:900;letter-spacing:.06em;text-transform:uppercase;}

    .input-bar{padding:12px 0 0;display:flex;gap:10px;align-items:center;}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo">D</div>
        <div>
          <div class="brand-title">DIGIY PRO CHAT</div>
          <div class="brand-sub">Supabase ‚Ä¢ Temps r√©el</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill"><span id="connDot" class="dot"></span><span id="connText">Connexion‚Ä¶</span></div>
        <div class="pill">Room: <b id="roomText">‚Äî</b></div>
        <button id="btnCopyLink" class="btn ghost" type="button">üîó Copier lien</button>
      </div>
    </header>

    <div class="layout">

      <aside class="sidebar">
        <div class="sidebar-top">
          <div style="font-weight:950;font-family:'Outfit',sans-serif;letter-spacing:.08em;text-transform:uppercase;">Rooms</div>
          <button id="btnApplyRoom" class="btn primary" type="button">Ouvrir</button>
        </div>

        <input id="roomInput" class="room-input" placeholder="Ex: RIDE_001 / resto-chez-baptiste" />

        <div class="hint">Astuce : URL <code>?chat=RIDE_001</code></div>

        <div id="quickRooms"></div>
      </aside>

      <main class="main">
        <div class="main-head">
          <div>
            <div class="h-title" id="mainTitle">Salon ‚Äî</div>
            <div class="h-sub">Historique + messages temps r√©el</div>
          </div>

          <div class="who">
            <span class="tag">Mode</span>
            <select id="modeSelect" class="select">
              <option value="pro" selected>PRO</option>
              <option value="client">CLIENT</option>
            </select>

            <span class="tag">Nom</span>
            <input id="nameInput" class="input" placeholder="Ex: Lamine / Astou Boutique" maxlength="40" />
          </div>
        </div>

        <div class="messages" id="messagesList" aria-live="polite"></div>

        <div class="input-bar">
          <input id="chatInput" class="input" style="flex:1" placeholder="√âcrire un message‚Ä¶" autocomplete="off" />
          <button id="sendBtn" class="btn primary" type="button">Envoyer ‚Üí</button>
        </div>

        <div class="hint">Test : ouvre <code>?chat=RIDE_001</code> dans deux onglets (PRO/CLIENT).</div>
      </main>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";


    const TABLE = "digiy_chat_messages";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false }
    });

    const messagesList = document.getElementById("messagesList");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");

    const modeSelect = document.getElementById("modeSelect");
    const nameInput = document.getElementById("nameInput");

    const roomText = document.getElementById("roomText");
    const mainTitle = document.getElementById("mainTitle");

    const roomInput = document.getElementById("roomInput");
    const btnApplyRoom = document.getElementById("btnApplyRoom");
    const btnCopyLink = document.getElementById("btnCopyLink");
    const quickRooms = document.getElementById("quickRooms");

    const qs = new URLSearchParams(location.search);
    const LS_KEY = "digiy_chat_identity_v1";

    let CHAT_ID = (qs.get("chat") || "RIDE_001").trim();
    let channel = null;

    function safeJson(s){ try{ return JSON.parse(s); } catch { return null; } }
    function randomId(prefix="id_"){ return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16); }

    const saved = safeJson(localStorage.getItem(LS_KEY)) || {};
    let sender_type = saved.sender_type || (qs.get("mode") || "pro");
    let sender_name = saved.sender_name || (qs.get("name") || "");
    let sender_id = saved.sender_id || randomId("u_");

    modeSelect.value = sender_type === "client" ? "client" : "pro";
    nameInput.value = sender_name;
    roomInput.value = CHAT_ID;

    function setConn(ok, text){
      connDot.classList.remove("ok","bad");
      connDot.classList.add(ok ? "ok" : "bad");
      connText.textContent = text;
    }

    function setRoomUI(){
      roomText.textContent = CHAT_ID;
      mainTitle.textContent = "Salon ‚Äî " + CHAT_ID;
      document.title = "DIGIY PRO CHAT ‚Äî " + CHAT_ID;
    }

    function scrollDown(){
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    function saveIdentity(){
      sender_type = modeSelect.value === "client" ? "client" : "pro";
      sender_name = (nameInput.value || "").trim();
      localStorage.setItem(LS_KEY, JSON.stringify({ sender_type, sender_name, sender_id }));
    }

    function renderMessage(msg){
      const row = document.createElement("div");
      row.className = "msg-row " + (msg.sender_type === "pro" ? "pro" : "client");

      const bubble = document.createElement("div");
      bubble.className = "msg " + (msg.sender_type === "pro" ? "pro" : "client");
      bubble.textContent = (msg.text || "").toString();

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const who = msg.sender_name || (msg.sender_type === "pro" ? "PRO" : "CLIENT");
      const time = msg.created_at ? new Date(msg.created_at).toLocaleString("fr-FR") : "";
      meta.textContent = time ? `${who} ‚Ä¢ ${time}` : who;

      row.appendChild(bubble);
      row.appendChild(meta);
      messagesList.appendChild(row);
      scrollDown();
    }

    async function loadMessages(){
      setConn(false, "Chargement‚Ä¶");
      messagesList.innerHTML = "";

      const { data, error } = await supabase
        .from(TABLE)
        .select("*")
        .eq("chat_id", CHAT_ID)
        .order("created_at", { ascending: true })
        .limit(500);

      if(error){
        console.error(error);
        setConn(false, "Erreur (RLS/table)");
        messagesList.innerHTML = `<div class="hint">‚ö†Ô∏è Lecture bloqu√©e. V√©rifie RLS sur <code>${TABLE}</code>.</div>`;
        return;
      }

      (data || []).forEach(renderMessage);
      setConn(true, "Connect√©");
    }

    function startRealtime(){
      if(channel){
        supabase.removeChannel(channel);
        channel = null;
      }

      channel = supabase
        .channel("room_" + CHAT_ID)
        .on("postgres_changes",
          { event: "INSERT", schema: "public", table: TABLE },
          (payload) => {
            const msg = payload.new;
            if(msg && msg.chat_id === CHAT_ID){
              renderMessage(msg);
            }
          }
        )
        .subscribe((status) => {
          if(status === "SUBSCRIBED") setConn(true, "Temps r√©el actif");
        });
    }

    async function sendMessage(){
      const text = (chatInput.value || "").trim();
      if(!text) return;

      saveIdentity();
      sendBtn.disabled = true;

      const { error } = await supabase
        .from(TABLE)
        .insert({
          chat_id: CHAT_ID,
          sender_id,
          sender_type,
          sender_name,
          text
        });

      sendBtn.disabled = false;

      if(error){
        console.error(error);
        alert("Envoi bloqu√©. V√©rifie RLS/table Supabase.");
        return;
      }

      chatInput.value = "";
      chatInput.focus();
    }

    function buildQuickRooms(){
      const presets = [
        { id: "RIDE_001", label: "chauffeur" },
        { id: "HUB_SUPPORT", label: "support" },
        { id: "RESTO_DEMO", label: "resto" },
      ];

      quickRooms.innerHTML = "";
      presets.forEach(p => {
        const item = document.createElement("div");
        item.className = "chat-item";
        item.innerHTML = `
          <div class="chat-avatar">${p.id.slice(0,1)}</div>
          <div class="chat-meta">
            <div class="chat-name">${p.id}</div>
            <div class="chat-sub">${p.label}</div>
          </div>
        `;
        item.addEventListener("click", () => {
          roomInput.value = p.id;
          applyRoom();
        });
        quickRooms.appendChild(item);
      });
    }

    function applyRoom(){
      const next = (roomInput.value || "").trim();
      if(!next) return;

      CHAT_ID = next;

      const url = new URL(location.href);
      url.searchParams.set("chat", CHAT_ID);
      url.searchParams.set("mode", modeSelect.value);
      const nm = (nameInput.value || "").trim();
      if(nm) url.searchParams.set("name", nm);
      history.replaceState({}, "", url.toString());

      setRoomUI();
      loadMessages();
      startRealtime();
    }

    btnApplyRoom.addEventListener("click", applyRoom);
    roomInput.addEventListener("keydown", (e) => { if(e.key === "Enter") applyRoom(); });

    btnCopyLink.addEventListener("click", async () => {
      saveIdentity();
      const url = new URL(location.href);
      url.searchParams.set("chat", CHAT_ID);
      url.searchParams.set("mode", modeSelect.value);
      const nm = (nameInput.value || "").trim();
      if(nm) url.searchParams.set("name", nm);

      try{
        await navigator.clipboard.writeText(url.toString());
        alert("Lien copi√© ‚úÖ");
      } catch {
        prompt("Copie le lien :", url.toString());
      }
    });

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (e) => { if(e.key === "Enter") sendMessage(); });

    modeSelect.addEventListener("change", saveIdentity);
    nameInput.addEventListener("change", saveIdentity);

    // BOOT
    (function boot(){
      setRoomUI();
      buildQuickRooms();
      saveIdentity();
      loadMessages();
      startRealtime();
    })();
  </script>
</body>
</html>
